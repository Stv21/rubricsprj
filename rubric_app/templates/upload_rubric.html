{% extends "base.html" %}
{% block title %}Upload Rubric{% endblock %}
{% block content %}

<h2>Upload Rubric for {{ classroom.name }}</h2>

<!-- Button to trigger the file upload -->
<button id="uploadButton">Upload Rubric</button>
<input type="file" id="rubricFile" style="display: none;" accept="image/*">
<span id="fileName" style="margin-left: 10px; display: none;"></span>

<p id="successMessage" style="color: green; display: none;">Rubric uploaded successfully!</p>
<p id="errorMessage" style="color: red; display: none;">Error in uploading rubric!</p>

<!-- Loader -->
<div id="loader" class="loader" style="display: none;"></div>

<!-- Displaying marks -->
<h3>Extracted Marks:</h3>
<ul id="extractedMarksList" style="display: none;">
    <li>Knowledge: <span id="knowledge"></span></li>
    <li>Performance: <span id="performance"></span></li>
    <li>Content & Neatness: <span id="content_neatness"></span></li>
    <li>Punctuality & Submission: <span id="punctuality_submission"></span></li>
    <li>Total Marks: <span id="total_marks"></span></li>
</ul>

<a href="{% url 'student_dashboard' %}">Back to Dashboard</a>

<!-- CSS for Loader -->
<style>
    .loader {
        border: 4px solid #f3f3f3;
        border-radius: 50%;
        border-top: 4px solid #3498db;
        width: 40px;
        height: 40px;
        animation: spin 2s linear infinite;
        margin-top: 20px;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<script>
    document.getElementById('uploadButton').onclick = function() {
        document.getElementById('rubricFile').click();
    };

    document.getElementById('rubricFile').onchange = function(event) {
        var file = event.target.files[0];
        if (file) {
            document.getElementById('fileName').innerText = file.name;
            document.getElementById('fileName').style.display = 'inline';
            var formData = new FormData();
            formData.append('rubric_file', file);
            
            // Show loader when starting upload
            document.getElementById('loader').style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';

            fetch("{% url 'upload_rubric' classroom.id %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Hide loader after upload completes
                document.getElementById('loader').style.display = 'none';

                if (data.success) {
                    document.getElementById('successMessage').style.display = 'block';
                    document.getElementById('extractedMarksList').style.display = 'block';
                    document.getElementById('knowledge').innerText = data.knowledge;
                    document.getElementById('punctuality_submission').innerText = data.performance;
                    document.getElementById('performance').innerText = data.content_neatness;
                    document.getElementById('content_neatness').innerText = data.punctuality_submission;
                    document.getElementById('total_marks').innerText = data.total_marks;
                } else {
                    document.getElementById('errorMessage').style.display = 'block';
                    console.error('Error:', data.message);
                }
            })
            .catch(error => {
                // Hide loader if an error occurs
                document.getElementById('loader').style.display = 'none';
                console.error('Error:', error);
                document.getElementById('errorMessage').style.display = 'block';
            });
        }
    };
</script>

{% endblock %}
